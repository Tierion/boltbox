version: '3.7'
services:

    # btc is an image of bitcoin node which used as base image for btcd and
    # btccli. The environment variables default values determined on stage of
    # container start within starting script.
    btc: &btc
      image: btcd
      build:
        context: ../docker/btcd/
      volumes:
            - shared:/rpc
            - bitcoin:/data
      environment:
        - RPCUSER
        - RPCPASS
        - NETWORK

    btcd:
      <<: *btc
      container_name: btcd
      environment:
        - DEBUG
        - MINING_ADDRESS
        - NETWORK
      entrypoint: ["./start-btcd.sh"]

    btcctl:
      <<: *btc
      container_name: btcctl
      links:
          - "btcd:rpcserver"
      entrypoint: ["./start-btcctl.sh"]

    lnd: &lnd
      image: lnd
      build:
        context: ../docker/lnd/
        dockerfile: Dockerfile
      environment:
        - RPCUSER
        - RPCPASS
        - NETWORK
        - CHAIN
        - DEBUG
      volumes:
          - shared:/rpc
          - lnd:/lnd-data
          - ./start-lnd.sh:/start-lnd.sh
      entrypoint: ["./start-lnd.sh"]

    lnd_btc: &lnd_btc
      <<: *lnd
      container_name: lnd_btc
      links:
          - "btcd:blockchain"

    lncli:
      <<: *lnd_btc
      container_name: lncli
      entrypoint: ["./start-lncli.sh"]

volumes:
  # shared volume is need to store the btcd rpc certificates and use it within
  # btcctl and lnd containers.
  shared:
    driver: local

  # bitcoin volume is needed for maintaining blockchain persistence
  # during btcd container recreation.
  bitcoin:
    driver: local

  # lnd volume for maintaining lnd wallet persistence
  # during container recreation.
  lnd:
    driver: local